<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–î–µ—Å—è—Ç—å –°–≤–µ—á–µ–π ‚Äî –æ–±—â–∏–π –ø—É–ª</title>
<style>
:root{--bg:#0f1117;--card:#161a23;--line:#232838;--text:#e6e6e6;--muted:#b7c0d1;--ok:#7CFC7C;--danger:#ff6b6b}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
header{padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#0f1117cc;backdrop-filter:blur(8px)}
h1{margin:0;font-size:18px}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:900px){main{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.title{font-weight:700;margin-bottom:8px}.candles{display:flex;gap:6px;flex-wrap:wrap}
.candle{width:24px;height:24px;border-radius:6px;display:grid;place-items:center;border:1px solid var(--line);background:#1f2536}
.candle.lit{background:#2c334a;color:#ffd166;text-shadow:0 0 8px #ffd166}
.btn{border:1px solid var(--line);background:#24304a;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;color:var(--muted)}
.players{display:flex;flex-direction:column;gap:12px}
.player{border:1px dashed var(--line);border-radius:12px;padding:12px}
.badge{border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;color:var(--muted)}
.label{font-size:12px;color:var(--muted)} .hr{height:1px;background:var(--line);margin:10px 0}
.dice{font-family:ui-monospace,Menlo,Consolas,monospace;display:flex;gap:6px;flex-wrap:wrap}
.die{padding:4px 6px;border-radius:6px;border:1px solid var(--line);background:#0e1424;min-width:26px;text-align:center}
.die.six{background:#1a2a1e;color:var(--ok);border-color:#2a4a2f;font-weight:700}
.die.one{opacity:.7}
.log{max-height:280px;overflow:auto;background:#0e1220;border:1px solid var(--line);padding:12px;border-radius:10px;white-space:pre-wrap}
.success{color:var(--ok)} .fail{color:var(--danger)}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>–î–µ—Å—è—Ç—å –°–≤–µ—á–µ–π ¬∑ –ü–∞–Ω–µ–ª—å</h1>
    <span class="pill" id="scenePill">–°—Ü–µ–Ω–∞ 1</span>
    <span class="pill" id="candlesPill">–°–≤–µ—á–∏: 10</span>
    <span class="pill" id="poolPill">–ü—É–ª –∏–≥—Ä–æ–∫–æ–≤: 10</span>
    <span class="pill" id="gmPill">–ü—É–ª –ì–ú–∞: 0</span>
  </div>
</header>

<main>
  <section class="card">
    <div class="title">–°–≤–µ—á–∏ –∏ —Å—Ü–µ–Ω—ã</div>
    <div class="candles" id="candles"></div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="extinguishBtn">üïØ –ü–æ–≥–∞—Å–∏—Ç—å —Å–≤–µ—á—É</button>
      <button class="btn" id="newSceneBtn">üß≠ –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞</button>
      <span class="badge" id="finalBadge" style="display:none">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞: –ø—Ä–æ–≤–∞–ª = —Å–º–µ—Ä—Ç—å</span>
    </div>
    <div class="hr"></div>
    <div class="label">–ü–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–ò—Å—Ç–∏–Ω¬ª:</div>
    <div class="label">¬´–í–æ—Ç –≤—Å—ë, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å. –ú–∏—Ä –ø–æ–≥—Ä—É–∂—ë–Ω –≤–æ —Ç—å–º—É.¬ª ‚Üí –∏—Å—Ç–∏–Ω—ã = —á–∏—Å–ª—É —Å–≤–µ—á–µ–π ‚Üí –≤–º–µ—Å—Ç–µ: ¬´–ò –º—ã –∂–∏–≤—ã¬ª.</div>
  </section>

  <section class="card">
    <div class="title">–ò–≥—Ä–æ–∫–∏</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="newPlayerName" placeholder="–ò–º—è" style="flex:1;min-width:140px">
      <button class="btn" id="addPlayerBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="btn-ghost btn" id="giveHopeAll">‚ú® –í—ã–¥–∞—Ç—å –ù–∞–¥–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∞–ø)</button>
    </div>
    <div class="players" id="players"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="title">–õ–æ–≥</div>
    <div class="log" id="log"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-ghost btn" id="clearLog">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </section>
</main>

<template id="playerTmpl">
  <div class="player">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="font-weight:700" class="pname"></div>
      <span class="badge hope">–ù–∞–¥–µ–∂–¥–∞: <span class="phope">–Ω–µ—Ç</span></span>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn roll">üé≤ –ë—Ä–æ—Å–æ–∫ (–æ–±—â–∏–π –ø—É–ª)</button>
      <button class="btn rollHope">üé≤+–ù–∞–¥–µ–∂–¥–∞</button>
      <button class="btn-ghost btn rerollTraitV">üî• –î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª</button>
      <button class="btn-ghost btn rerollTraitC">üî• –ü–æ—Ä–æ–∫ ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª</button>
      <button class="btn-ghost btn brink">‚ö° –ì—Ä–∞–Ω—å (–ø–µ—Ä–µ–±—Ä–æ—Å –≤—Å–µ–≥–æ)</button>
    </div>
    <div class="hr"></div>
    <div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –±—Ä–æ—Å–æ–∫:</div>
    <div class="dice pdice"></div>
    <div class="label" style="margin-top:4px">–ö—É–±—ã –≤–µ–¥—É—â–µ–≥–æ:</div>
    <div class="dice gdice"></div>
    <div class="label" style="margin-top:4px">–ò—Ç–æ–≥:</div>
    <div class="label res">‚Äî</div>
  </div>
</template>

<script>
const $= (s,r=document)=>r.querySelector(s);
const state = {
  scene:1, candles:10,
  sharedPool:10, // –æ–±—â–∏–π –ø—É–ª –∏–≥—Ä–æ–∫–æ–≤
  gmPool(){ return Math.max(0, this.scene-1); },
  players:[], nextId:1,
  lastSelectedId:null // –∫–æ–≥–æ ¬´—Ç—Ä–æ–≥–∞–ª–∏¬ª –ø–æ—Å–ª–µ–¥–Ω–∏–º (–¥–ª—è –≤—ã–¥–∞—á–∏ –ù–∞–¥–µ–∂–¥—ã –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π)
};

function rng(n){ return Array.from({length:Math.max(0,n)},()=>1+Math.floor(Math.random()*6)); }
function updatePills(){
  $('#scenePill').textContent=`–°—Ü–µ–Ω–∞ ${state.scene}`;
  $('#candlesPill').textContent=`–°–≤–µ—á–∏: ${state.candles}`;
  $('#poolPill').textContent=`–ü—É–ª –∏–≥—Ä–æ–∫–æ–≤: ${state.sharedPool}`;
  $('#gmPill').textContent=`–ü—É–ª –ì–ú–∞: ${state.gmPool()}`;
  $('#finalBadge').style.display = (state.candles===1)?'inline-block':'none';
}
function renderCandles(){
  const box=$('#candles'); box.innerHTML='';
  for(let i=0;i<10;i++){
    const b=document.createElement('button');
    b.className='candle'+(i<state.candles?' lit':'');
    b.textContent=i<state.candles?'üïØ':'‚óº';
    b.onclick=()=>{ state.candles=i+1; state.sharedPool=state.candles; updatePills(); };
    box.appendChild(b);
  }
  updatePills();
}
function log(t){ const box=$('#log'); box.textContent+=(box.textContent?'\n\n':'')+t; box.scrollTop=box.scrollHeight; }

function extinguishCandle(){
  if(state.candles<=0) return;
  state.candles--; state.scene++;
  state.sharedPool = state.candles; // –æ–±—â–∏–π –ø—É–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫ —á–∏—Å–ª—É —Å–≤–µ—á–µ–π
  updatePills(); renderPlayers();
  log(`üïØ –°–≤–µ—á–∞ –ø–æ–≥–∞—à–µ–Ω–∞. –û—Å—Ç–∞–ª–æ—Å—å: ${state.candles}. –†–∏—Ç—É–∞–ª ¬´–ò—Å—Ç–∏–Ω¬ª.`);
}
function newScene(){
  state.scene++; // —Å–≤–µ—á–∏ —Ç–µ –∂–µ, –Ω–æ –Ω–æ–≤–∞—è —Å—Ü–µ–Ω–∞
  state.sharedPool = state.candles;
  updatePills(); renderPlayers();
  log(`üß≠ –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ${state.scene}. –û–±—â–∏–π –ø—É–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ ${state.sharedPool}.`);
}

function addPlayer(name){
  if(!name.trim()) return;
  state.players.push({id:state.nextId++, name, hope:false, traitV:true, traitC:true, brink:true, last:null});
  renderPlayers();
}

function roll(withHope, player){
  const poolBefore = state.sharedPool;
  if(poolBefore<=0){ log(`‚ö†Ô∏è –û–±—â–∏–π –ø—É–ª –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É.`); return; }
  // –±—Ä–æ—Å–∞–µ–º –æ–±—â–∏–π –ø—É–ª –∏ –ì–ú–∞
  const pDice = rng(poolBefore);
  const gDice = rng(state.gmPool());
  let hopeVal=null;
  if(withHope && player.hope){ hopeVal = 1+Math.floor(Math.random()*6); }
  // —É—Å–ø–µ—Ö/–ø—Ä–∞–≤–æ —Ä–∞—Å—Å–∫–∞–∑–∞
  const success = pDice.includes(6) || (hopeVal!==null && hopeVal>=5);
  const narrator = (success && (pDice.filter(x=>x===6).length > gDice.filter(x=>x===6).length)) ? '–∏–≥—Ä–æ–∫' : '–≤–µ–¥—É—â–∏–π';
  // –ø—Ä–∏ —É—Å–ø–µ—Ö–µ ¬´1¬ª —É—Ö–æ–¥—è—Ç –∏–∑ –æ–±—â–µ–≥–æ –ø—É–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞ —Å—Ü–µ–Ω—ã
  const ones = pDice.filter(x=>x===1).length;
  if(success){
    state.sharedPool = Math.max(0, state.sharedPool - ones);
  }else{
    extinguishCandle();
  }
  player.last = {pDice,gDice,hopeVal,success,narrator,onesRemoved:ones,poolBefore};
  state.lastSelectedId = player.id;
  renderPlayers();
  const fmt = a=>a.map(v=>v===6?`[${v}]`:v).join(' ');
  log(
    `${player.name} ‚Äî –æ–±—â–∏–π –ø—É–ª –¥–æ –±—Ä–æ—Å–∫–∞: ${poolBefore}\n–ò–≥—Ä–æ–∫: ${fmt(pDice)}\n–ì–ú: ${fmt(gDice)}`
    +(hopeVal!==null?`\n–ù–∞–¥–µ–∂–¥–∞: ${hopeVal} ‚Üí ${hopeVal>=5?'—É—Å–ø–µ—Ö':'–ø—Ä–æ–≤–∞–ª'}`:'')
    +`\n${success?'‚úÖ –£–°–ü–ï–•':'‚ùå –ü–†–û–í–ê–õ'} ¬∑ –ü—Ä–∞–≤–æ —Ä–∞—Å—Å–∫–∞–∑–∞: ${narrator}\n–ò–∑ –æ–±—â–µ–≥–æ –ø—É–ª–∞ —É–±—Ä–∞–Ω–æ: ${ones} √ó ¬´1¬ª ‚Üí —Ç–µ–ø–µ—Ä—å ${state.sharedPool}`
  );
}

function rerollTrait(player, which){ // –ø–µ—Ä–µ–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ ¬´1¬ª –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—Ä–æ—Å–∫–∞
  const l = player.last; if(!l){ alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ –±—Ä–æ—Å–æ–∫.'); return; }
  if(which==='V' && !player.traitV){ alert('–î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å —É–∂–µ —Å–æ–∂–∂–µ–Ω–∞.'); return; }
  if(which==='C' && !player.traitC){ alert('–ü–æ—Ä–æ–∫ —É–∂–µ —Å–æ–∂–∂—ë–Ω.'); return; }
  const idx=[]; l.pDice.forEach((v,i)=>{ if(v===1) idx.push(i); });
  if(!idx.length){ alert('–í –ø–æ—Å–ª–µ–¥–Ω–µ–º –±—Ä–æ—Å–∫–µ –Ω–µ—Ç ¬´1¬ª.'); return; }
  idx.forEach(i=> l.pDice[i]=1+Math.floor(Math.random()*6));
  const success = l.pDice.includes(6) || (l.hopeVal!==null && l.hopeVal>=5);
  const narrator = (success && (l.pDice.filter(x=>x===6).length>l.gDice.filter(x=>x===6).length)) ? '–∏–≥—Ä–æ–∫':'–≤–µ–¥—É—â–∏–π';
  const ones = l.pDice.filter(x=>x===1).length;
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –ø—É–ª –ø–æ –ø—Ä–∞–≤–∏–ª—É: –æ–Ω –¥–æ–ª–∂–µ–Ω —Ä–∞–≤–Ω—è—Ç—å—Å—è "poolBefore - –∫–æ–ª-–≤–æ 1 –≤ –∏—Ç–æ–≥–æ–≤–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ"
  state.sharedPool = Math.max(0, l.poolBefore - ones);
  l.success=success; l.narrator=narrator; l.onesRemoved=ones;
  if(which==='V') player.traitV=false; else player.traitC=false;
  renderPlayers();
  log(`üî• ${player.name} —Å–∂—ë–≥ ${which==='V'?'–î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å':'–ü–æ—Ä–æ–∫'} ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª. –ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –æ–±—â–µ–≥–æ –ø—É–ª–∞: ${state.sharedPool}.`);
}

function useBrink(player){
  if(!player.brink){ alert('–ì—Ä–∞–Ω—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞.'); return; }
  // –ü–µ—Ä–µ–±—Ä–æ—Å –≤—Å–µ–≥–æ –ø—É–ª–∞ (–æ–±—â–µ–≥–æ)
  const poolBefore = state.sharedPool;
  const pDice = rng(poolBefore), gDice = rng(state.gmPool());
  const success = pDice.includes(6);
  const narrator = (success && (pDice.filter(x=>x===6).length>gDice.filter(x=>x===6).length)) ? '–∏–≥—Ä–æ–∫':'–≤–µ–¥—É—â–∏–π';
  const ones = pDice.filter(x=>x===1).length;
  if(success){ state.sharedPool = Math.max(0, poolBefore - ones); }
  else { player.hope=false; extinguishCandle(); player.brink=false; }
  player.last={pDice,gDice,hopeVal:null,success,narrator,onesRemoved:ones,poolBefore};
  renderPlayers();
  log(`‚ö° ${player.name} –±—Ä–æ—Å–∏–ª –Ω–∞ –ì—Ä–∞–Ω–∏. ${success?'–£—Å–ø–µ—Ö':'–ü—Ä–æ–≤–∞–ª'}; –æ—Å—Ç–∞—Ç–æ–∫ –æ–±—â–µ–≥–æ –ø—É–ª–∞: ${state.sharedPool}.`);
}

function renderPlayers(){
  const wrap=$('#players'); wrap.innerHTML='';
  state.players.forEach(p=>{
    const t=$('#playerTmpl').content.cloneNode(true);
    $('.pname',t).textContent=p.name;
    $('.phope',t).textContent=p.hope?'–µ—Å—Ç—å':'–Ω–µ—Ç';
    $('.roll',t).onclick=()=>roll(false,p);
    $('.rollHope',t).onclick=()=>roll(true,p);
    $('.rerollTraitV',t).onclick=()=>rerollTrait(p,'V');
    $('.rerollTraitC',t).onclick=()=>rerollTrait(p,'C');
    $('.brink',t).onclick=()=>useBrink(p);
    // –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—Ä–æ—Å–æ–∫
    const pd=$('.pdice',t), gd=$('.gdice',t), res=$('.res',t);
    if(p.last){
      p.last.pDice.forEach(v=>{ const s=document.createElement('span'); s.className='die'+(v===6?' six':(v===1?' one':'')); s.textContent=v; pd.appendChild(s); });
      p.last.gDice.forEach(v=>{ const s=document.createElement('span'); s.className='die'+(v===6?' six':(v===1?' one':'')); s.textContent=v; gd.appendChild(s); });
      res.innerHTML = (p.last.success?'<span class="success">–£–°–ü–ï–•</span>':'<span class="fail">–ü
