<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–î–µ—Å—è—Ç—å –°–≤–µ—á–µ–π ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –≤–µ–¥—É—â–µ–≥–æ</title>
<style>
:root{--bg:#0f1117;--card:#161a23;--line:#232838;--text:#e6e6e6;--muted:#aab3c5;--ok:#7CFC7C;--bad:#ff6b6b;--warn:#ffd166}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:#0f1117cc;border-bottom:1px solid var(--line);padding:12px 16px;backdrop-filter:blur(8px);z-index:5}
h1{margin:0;font-size:18px} .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:900px){main{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
.title{font-weight:700;margin-bottom:6px}
.btn{border:1px solid var(--line);background:#24304a;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;color:var(--muted)}
.badge{border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.candles{display:flex;gap:6px;flex-wrap:wrap}
.candle{width:22px;height:22px;border-radius:6px;display:grid;place-items:center;border:1px solid var(--line);background:#1b2132}
.candle.lit{background:#2b3249;color:#ffd166;text-shadow:0 0 8px #ffd166}
.grid{display:grid;gap:8px;grid-template-columns:1fr 1fr}
.players{display:flex;flex-direction:column;gap:12px}
.player{border:1px dashed var(--line);border-radius:12px;padding:12px}
.hr{height:1px;background:var(--line);margin:10px 0}
.dice{font-family:ui-monospace,Menlo,Consolas,monospace;display:flex;gap:6px;flex-wrap:wrap}
.die{padding:4px 6px;border-radius:6px;border:1px solid var(--line);background:#0e1424;min-width:26px;text-align:center}
.die.six{background:#1a2a1e;color:var(--ok);border-color:#2a4a2f;font-weight:700}
.die.one{opacity:.7}
.log{max-height:320px;overflow:auto;background:#0e1220;border:1px solid var(--line);padding:10px;border-radius:10px;white-space:pre-wrap}
.success{color:var(--ok)} .fail{color:var(--bad)} .warn{color:var(--warn)}
input[type="text"]{width:100%;background:#0f1320;border:1px solid var(--line);color:#fff;border-radius:8px;padding:8px}
label{user-select:none}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>–î–µ—Å—è—Ç—å –°–≤–µ—á–µ–π</h1>
    <span class="pill" id="sceneP">–°—Ü–µ–Ω–∞ 1</span>
    <span class="pill" id="candlesP">–°–≤–µ—á–∏: 10</span>
    <span class="pill" id="poolP">–ü—É–ª –∏–≥—Ä–æ–∫–æ–≤: 10</span>
    <span class="pill" id="gmP">–ü—É–ª –ì–ú–∞: 0</span>
  </div>
</header>

<main>
  <section class="card">
    <div class="title">–°–≤–µ—á–∏ –∏ —Å—Ü–µ–Ω—ã</div>
    <div id="candles" class="candles"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn" id="extinguish">üïØ –ü–æ–≥–∞—Å–∏—Ç—å —Å–≤–µ—á—É</button>
      <button class="btn" id="newScene">üß≠ –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞</button>
      <span class="badge" id="finalB" style="display:none">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞: –ø—Ä–æ–≤–∞–ª = —Å–º–µ—Ä—Ç—å</span>
    </div>
    <div class="hr"></div>
    <div class="small">–†–∏—Ç—É–∞–ª –∏—Å—Ç–∏–Ω: ¬´<b>–í–æ—Ç –≤—Å—ë, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å. –ú–∏—Ä –ø–æ–≥—Ä—É–∂—ë–Ω –≤–æ —Ç—å–º—É.</b>¬ª ‚Üí –ø–æ –∫—Ä—É–≥—É –∏—Å—Ç–∏–Ω—ã (–∏—Ö —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—è—â–∏—Ö —Å–≤–µ—á–µ–π) ‚Üí –≤–º–µ—Å—Ç–µ: ¬´<b>–ò –º—ã –∂–∏–≤—ã</b>¬ª.</div>
  </section>

  <section class="card">
    <div class="title">–ò–≥—Ä–æ–∫–∏</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="name" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞" style="flex:1;min-width:140px">
      <button class="btn" id="add">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="players" class="players"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="title">–õ–æ–≥</div>
    <div id="log" class="log"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn-ghost btn" id="clearLog">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </section>
</main>

<template id="pT">
  <div class="player">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="font-weight:700" class="nm"></div>
      <span class="badge">–ù–∞–¥–µ–∂–¥–∞: <b class="hope">–Ω–µ—Ç</b></span>
      <span class="badge">–ß–µ—Ä—Ç—ã: <span class="traits">2 –∞–∫—Ç–∏–≤–Ω—ã</span></span>
      <span class="badge">–ì—Ä–∞–Ω—å: <span class="brink">—Å–∫—Ä—ã—Ç–∞</span></span>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <label><input type="checkbox" class="danger"> –û–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç</label>
      <button class="btn roll">üé≤ –ë—Ä–æ—Å–æ–∫ (–æ–±—â–∏–π –ø—É–ª)</button>
      <button class="btn rollH">üé≤+–ù–∞–¥–µ–∂–¥–∞</button>
      <button class="btn-ghost btn vBurn">üî• –°–∂–µ—á—å –¥–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å (–ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª)</button>
      <button class="btn-ghost btn cBurn">üî• –°–∂–µ—á—å –ø–æ—Ä–æ–∫ (–ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª)</button>
      <button class="btn-ghost btn brinkUse">‚ö° –ü—Ä–∏–Ω—è—Ç—å –ì—Ä–∞–Ω—å</button>
      <button class="btn-ghost btn intercept" style="display:none">üïØ –ü–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Ä–∞—Å—Å–∫–∞–∑</button>
    </div>
    <div class="hr"></div>
    <div class="small">–ú–æ–º–µ–Ω—Ç: <button class="btn-ghost btn doMoment">‚ú® –ü—Ä–æ–∂–∏—Ç—å –ú–æ–º–µ–Ω—Ç</button> (—É—Å–ø–µ—Ö ‚Üí –∫–æ—Å—Ç—å –ù–∞–¥–µ–∂–¥—ã, –ø—Ä–æ–≤–∞–ª ‚Üí –≥–∞—Å–Ω–µ—Ç —Å–≤–µ—á–∞)</div>
    <div class="hr"></div>
    <div class="small">–ü–æ—Å–ª–µ–¥–Ω–∏–π –±—Ä–æ—Å–æ–∫:</div>
    <div class="dice pDice"></div>
    <div class="small" style="margin-top:4px">–ö–æ—Å—Ç–∏ –ì–ú–∞:</div>
    <div class="dice gDice"></div>
    <div class="small res">‚Äî</div>
  </div>
</template>

<script>
const $=(s,r=document)=>r.querySelector(s); const rng=n=>Array.from({length:n},()=>1+Math.floor(Math.random()*6));
const state={
  scene:1,candles:10,
  shared:10,
  gmBonus:0, // –ª–∏—à–Ω–∏–µ –∫–æ—Å—Ç–∏, —É—à–µ–¥—à–∏–µ –∫ –ì–ú—É –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—É–ª–∞
  players:[], nextId:1
};
const gmPool=()=>Math.max(0,state.scene-1)+state.gmBonus;

function updPills(){
  $('#sceneP').textContent=`–°—Ü–µ–Ω–∞ ${state.scene}`;
  $('#candlesP').textContent=`–°–≤–µ—á–∏: ${state.candles}`;
  $('#poolP').textContent=`–ü—É–ª –∏–≥—Ä–æ–∫–æ–≤: ${state.shared}`;
  $('#gmP').textContent=`–ü—É–ª –ì–ú–∞: ${gmPool()}`;
  $('#finalB').style.display = (state.candles===1)?'inline-block':'none';
}
function drawCandles(){
  const box=$('#candles'); box.innerHTML='';
  for(let i=0;i<10;i++){
    const b=document.createElement('button');
    b.className='candle'+(i<state.candles?' lit':''); b.textContent=i<state.candles?'üïØ':'‚óº';
    b.onclick=()=>{state.candles=i+1; state.shared=state.candles; updPills();};
    box.appendChild(b);
  } updPills();
}
function log(t){ const L=$('#log'); L.textContent+=(L.textContent?'\n\n':'')+t; L.scrollTop=L.scrollHeight; }

function endScene(reason){
  if(state.candles<=0) return;
  state.candles--; state.scene++;
  state.shared = Math.min(state.candles, state.shared); // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ–∑–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª–∞ –¥–æ —á–∏—Å–ª–∞ —Å–≤–µ—á–µ–π; –ª–∏—à–Ω–∏–µ ‚Äî –∫ –ì–ú—É
  const restoreTo=state.candles; if(state.shared<restoreTo){ state.shared=restoreTo; }
  else if(state.shared>restoreTo){ state.gmBonus += (state.shared-restoreTo); state.shared=restoreTo; }
  updPills(); drawPlayers();
  log(`üïØ –°–≤–µ—á–∞ –ø–æ–≥–∞—à–µ–Ω–∞ (${reason}). –†–∏—Ç—É–∞–ª –∏—Å—Ç–∏–Ω. –ù–æ–≤—ã–π –æ–±—â–∏–π –ø—É–ª: ${state.shared}. –ü—É–ª –ì–ú–∞: ${gmPool()}.`);
}

function newScene(){
  state.scene++; // —Å–≤–µ—á–∏ —Ç–µ –∂–µ
  // –æ–±—â–∏–π –ø—É–ª –≤ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω—ã = —á–∏—Å–ª—É –≥–æ—Ä—è—â–∏—Ö —Å–≤–µ—á–µ–π
  const restoreTo=state.candles;
  if(state.shared<restoreTo) state.shared=restoreTo;
  else if(state.shared>restoreTo){ state.gmBonus+=(state.shared-restoreTo); state.shared=restoreTo; }
  updPills(); drawPlayers(); log(`üß≠ –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ${state.scene}. –û–±—â–∏–π –ø—É–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª—ë–Ω –¥–æ ${state.shared}.`);
}

function addPlayer(name){
  state.players.push({
    id:state.nextId++, name,
    hope:false,
    virtue:true, vice:true, // –¥–æ—Å—Ç—É–ø–Ω—ã
    burnedThisScene:false,
    brink:{known:false, available:false, burned:false}, // available —Å—Ç–∞–Ω–µ—Ç true –ø–æ—Å–ª–µ –ú–æ–º–µ–Ω—Ç–∞ –∏ —Å–æ–∂–∂—ë–Ω–Ω—ã—Ö –ß–µ—Ä—Ç
    last:null
  }); drawPlayers();
}

function renderOne(p,wrap){
  const t=$('#pT').content.cloneNode(true);
  $('.nm',t).textContent=p.name;
  $('.hope',t).textContent=p.hope?'–µ—Å—Ç—å':'–Ω–µ—Ç';
  $('.traits',t).textContent=(p.virtue?1:0)+(p.vice?1:0)+' –∞–∫—Ç–∏–≤–Ω—ã';
  $('.brink',t).textContent=p.brink.burned?'—Å–æ–∂–∂–µ–Ω–∞':(p.brink.available?'–∞–∫—Ç–∏–≤–Ω–∞':'—Å–∫—Ä—ã—Ç–∞');
  const res=$('.res',t), pD=$('.pDice',t), gD=$('.gDice',t);

  const doRoll=(useHope)=>{
    const danger=$('.danger',t).checked;
    const poolBefore=state.shared;
    if(poolBefore<=0){ log(`‚ö†Ô∏è –û–±—â–∏–π –ø—É–ª –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É.`); return; }
    const pDice=rng(poolBefore); const gDice=rng(gmPool());
    let hopeVal=null; if(useHope && p.hope) hopeVal=1+Math.floor(Math.random()*6);

    const success = pDice.includes(6) || (hopeVal!==null && hopeVal>=5);
    const pSix = pDice.filter(x=>x===6).length, gSix=gDice.filter(x=>x===6).length;
    const narrator = (success && pSix>gSix)?'–∏–≥—Ä–æ–∫':'–ì–ú'; // –Ω–∏—á—å—è –∑–∞ —Ä–∞—Å—Å–∫–∞–∑–æ–º ‚Äî —É –ì–ú–∞
    let ones=pDice.filter(x=>x===1).length;

    if(success){
      state.shared = Math.max(0, poolBefore - ones);
    }else{
      // –ø—Ä–æ–≤–∞–ª: –≥–∞—Å–∏–º —Å–≤–µ—á—É; –ø—Ä–∏ –æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ ‚Äî —É—Ç–æ—á–Ω–µ–Ω–∏–µ –≤ –ª–æ–≥–µ
      endScene(danger?'–ø—Ä–æ–≤–∞–ª –æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞':'–ø—Ä–æ–≤–∞–ª');
    }

    p.last={pDice,gDice,hopeVal,success,narrator,ones,poolBefore,canIntercept:(success && narrator==='–ì–ú')};
    // –ì—Ä–∞–Ω—å –¥–æ—Å—Ç—É–ø–Ω–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ú–æ–º–µ–Ω—Ç –±—ã–ª (hope==true) –ò –æ–±–µ —á–µ—Ä—Ç—ã —É–∂–µ —Å–æ–∂–∂–µ–Ω—ã
    p.brink.available = p.hope && !p.virtue && !p.vice && !p.brink.burned;

    drawPlayers();
    const fmt=a=>a.map(v=>v===6?`[${v}]`:v).join(' ');
    log(`${p.name} ‚Äî –æ–±—â–∏–π –ø—É–ª –¥–æ –±—Ä–æ—Å–∫–∞: ${poolBefore}\n–ò–≥—Ä–æ–∫: ${fmt(pDice)}${hopeVal!==null?`\n–ù–∞–¥–µ–∂–¥–∞: ${hopeVal}`:''}\n–ì–ú: ${fmt(gDice)}\n${success?`‚úÖ –£–°–ü–ï–• ¬∑ –ø—Ä–∞–≤–æ —Ä–∞—Å—Å–∫–∞–∑–∞: ${narrator}`:`‚ùå –ü–†–û–í–ê–õ${danger?' (–û–ü–ê–°–ù–´–ô)':''}`} ${success?`\n–°–Ω—è—Ç–æ ¬´1¬ª: ${ones} ‚Üí –ø—É–ª —Ç–µ–ø–µ—Ä—å ${state.shared}`:''}`);
  };

  $('.roll',t).onclick=()=>doRoll(false);
  $('.rollH',t).onclick=()=>doRoll(true);

  $('.vBurn',t).onclick=()=>{
    if(!p.virtue) return alert('–î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å —É–∂–µ —Å–æ–∂–∂–µ–Ω–∞.');
    if(p.burnedThisScene) return alert('–ó–∞ —Å—Ü–µ–Ω—É –º–æ–∂–Ω–æ —Å–∂–µ—á—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –ß–µ—Ä—Ç—É.');
    if(!p.last) return alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ –±—Ä–æ—Å–æ–∫.');
    // –ø–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ ¬´1¬ª
    const idx=[]; p.last.pDice.forEach((v,i)=>{ if(v===1) idx.push(i); });
    if(!idx.length) return alert('–í –ø–æ—Å–ª–µ–¥–Ω–µ–º –±—Ä–æ—Å–∫–µ –Ω–µ—Ç ¬´1¬ª.');
    idx.forEach(i=> p.last.pDice[i]=1+Math.floor(Math.random()*6));
    // –ø–µ—Ä–µ—Å—á—ë—Ç
    const ones=p.last.pDice.filter(x=>x===1).length;
    state.shared = Math.max(0, p.last.poolBefore - ones);
    p.virtue=false; p.burnedThisScene=true;
    p.brink.available = p.hope && !p.virtue && !p.vice && !p.brink.burned;
    drawPlayers(); log(`üî• ${p.name} —Å–∂—ë–≥ –î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª. –û–±—â–∏–π –ø—É–ª —Ç–µ–ø–µ—Ä—å: ${state.shared}.`);
  };

  $('.cBurn',t).onclick=()=>{
    if(!p.vice) return alert('–ü–æ—Ä–æ–∫ —É–∂–µ —Å–æ–∂–∂—ë–Ω.');
    if(p.burnedThisScene) return alert('–ó–∞ —Å—Ü–µ–Ω—É –º–æ–∂–Ω–æ —Å–∂–µ—á—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –ß–µ—Ä—Ç—É.');
    if(!p.last) return alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ –±—Ä–æ—Å–æ–∫.');
    const idx=[]; p.last.pDice.forEach((v,i)=>{ if(v===1) idx.push(i); });
    if(!idx.length) return alert('–í –ø–æ—Å–ª–µ–¥–Ω–µ–º –±—Ä–æ—Å–∫–µ –Ω–µ—Ç ¬´1¬ª.');
    idx.forEach(i=> p.last.pDice[i]=1+Math.floor(Math.random()*6));
    const ones=p.last.pDice.filter(x=>x===1).length;
    state.shared = Math.max(0, p.last.poolBefore - ones);
    p.vice=false; p.burnedThisScene=true;
    p.brink.available = p.hope && !p.virtue && !p.vice && !p.brink.burned;
    drawPlayers(); log(`üî• ${p.name} —Å–∂—ë–≥ –ü–æ—Ä–æ–∫ ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª. –û–±—â–∏–π –ø—É–ª —Ç–µ–ø–µ—Ä—å: ${state.shared}.`);
  };

  $('.brinkUse',t).onclick=()=>{
    if(!p.brink.available) return alert('–ì—Ä–∞–Ω—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω—É–∂–µ–Ω –ø—Ä–æ–∂–∏—Ç—ã–π –ú–æ–º–µ–Ω—Ç –∏ –æ–±–µ –ß–µ—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∂–∂–µ–Ω—ã).');
    if(!p.last) return alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ –±—Ä–æ—Å–æ–∫.');
    const pool=p.last.poolBefore;
    const pDice=rng(pool), gDice=rng(gmPool());
    const success = pDice.includes(6) || (p.hope && false); // –ù–∞–¥–µ–∂–¥–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å–≤–æ–∏–º –∫—É–±–æ–º –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî —Ç—É—Ç –ø–µ—Ä–µ–±—Ä–æ—Å –≤—Å–µ–≥–æ –ø—É–ª–∞ –æ–±—ã—á–Ω—ã—Ö –∫—É–±–æ–≤
    const narrator = success && (pDice.filter(x=>x===6).length > gDice.filter(x=>x===6).length) ? '–∏–≥—Ä–æ–∫':'–ì–ú';
    const ones=pDice.filter(x=>x===1).length;
    if(success){
      state.shared = Math.max(0, pool - ones);
      log(`‚ö° ${p.name} –ø—Ä–∏–Ω—è–ª –ì—Ä–∞–Ω—å ‚Üí –£–°–ü–ï–•. ¬´1¬ª —Å–Ω—è—Ç—ã: ${ones}. –ü—É–ª —Ç–µ–ø–µ—Ä—å ${state.shared}.`);
    }else{
      p.brink.burned=true; p.brink.available=false; p.hope=false;
      endScene('–ø—Ä–æ–≤–∞–ª –ø–æ—Å–ª–µ –ì—Ä–∞–Ω–∏ (–ù–∞–¥–µ–∂–¥–∞ —É—Ç–µ—Ä—è–Ω–∞, –ì—Ä–∞–Ω—å —Å–æ–∂–∂–µ–Ω–∞)');
    }
    p.last={pDice,gDice,hopeVal:null,success,narrator,ones,poolBefore:pool,canIntercept:(success && narrator==='–ì–ú')};
    drawPlayers();
  };

  $('.doMoment',t).onclick=()=>{
    // –û–¥–∏–Ω –±—Ä–æ—Å–æ–∫ –Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –ú–æ–º–µ–Ω—Ç–∞ (–æ–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞)
    const poolBefore=state.shared; const pDice=rng(poolBefore); const gDice=rng(gmPool());
    const success = pDice.includes(6);
    const narrator = success && (pDice.filter(x=>x===6).length>gDice.filter(x=>x===6).length) ? '–∏–≥—Ä–æ–∫':'–ì–ú';
    if(success){ p.hope=true; log(`‚ú® ${p.name} –ø—Ä–æ–∂–∏–ª –ú–æ–º–µ–Ω—Ç: –æ–±—Ä–µ—Ç–µ–Ω–∞ –∫–æ—Å—Ç—å –ù–∞–¥–µ–∂–¥—ã.`); }
    else{ endScene('–ú–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–∞–ª—ë–Ω ‚Äî –Ω–∞–¥–µ–∂–¥–∞ —É—Ç—Ä–∞—á–µ–Ω–∞'); }
    p.last={pDice,gDice,hopeVal:null,success,narrator,ones:pDice.filter(x=>x===1).length,poolBefore,canIntercept:(success && narrator==='–ì–ú')};
    // –ú–æ–º–µ–Ω—Ç —Å–æ–∂–∂—ë–Ω –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–∂–∏—Ç—å –Ω–µ–ª—å–∑—è (–º—ã –ª–∏—à—å –Ω–µ —Ö—Ä–∞–Ω–∏–º –µ–≥–æ –∫–∞–∫ –∫–∞—Ä—Ç—É)
    p.brink.available = p.hope && !p.virtue && !p.vice && !p.brink.burned;
    drawPlayers();
  };

  const interceptBtn=$('.intercept',t);
  if(p.last && p.last.canIntercept){ interceptBtn.style.display='inline-block';
    interceptBtn.onclick=()=>{ p.last.canIntercept=false; endScene('–ø–µ—Ä–µ—Ö–≤–∞—Ç –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–≥—Ä–æ–∫–æ–º'); drawPlayers(); };
  }

  if(p.last){
    p.last.pDice.forEach(v=>{const s=document.createElement('span'); s.className='die'+(v===6?' six':(v===1?' one':'')); s.textContent=v; pD.appendChild(s);});
    p.last.gDice.forEach(v=>{const s=document.createElement('span'); s.className='die'+(v===6?' six':(v===1?' one':'')); s.textContent=v; gD.appendChild(s);});
    res.innerHTML=(p.last.success?'<span class="success">–£–°–ü–ï–•</span>':'<span class="fail">–ü–†–û–í–ê–õ</span>')+` ¬∑ —Ä–∞—Å—Å–∫–∞–∑: <b>${p.last.narrator}</b>`;
  }
  wrap.appendChild(t);
}

function drawPlayers(){
  const wrap=$('#players'); wrap.innerHTML='';
  state.players.forEach(p=>renderOne(p,wrap));
  drawCandles(); updPills();
}

$('#add').onclick=()=>{ const n=$('#name').value||`–ò–≥—Ä–æ–∫ ${state.players.length+1}`; $('#name').value=''; addPlayer(n); };
$('#extinguish').onclick=()=>endScene('–ø–æ —Ä–µ—à–µ–Ω–∏—é –≤–µ–¥—É—â–µ–≥–æ/—Å–æ–±—ã—Ç–∏—é');
$('#newScene').onclick=newScene;
$('#clearLog').onclick=()=>{$('#log').textContent='';};
drawCandles(); updPills(); drawPlayers();
</script>
</body>
</html>
