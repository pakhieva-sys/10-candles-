<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ten Candles ¬∑ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –¥–æ—Å–∫–∞</title>
<style>
:root{--bg:#0f1117;--card:#161a23;--line:#232838;--text:#e6e6e6;--muted:#aab3c5;--ok:#7CFC7C;--bad:#ff6b6b;--warn:#ffd166}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:#0f1117cc;border-bottom:1px solid var(--line);padding:10px 14px;backdrop-filter:blur(8px);z-index:5}
h1{margin:0;font-size:18px}.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
main{padding:14px;display:grid;gap:14px;grid-template-columns:1fr} @media(min-width:900px){main{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.title{font-weight:700;margin-bottom:6px}
.btn{border:1px solid var(--line);background:#24304a;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;color:var(--muted)}
.badge{border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.candles{display:flex;gap:6px;flex-wrap:wrap}
.candle{width:22px;height:22px;border-radius:6px;display:grid;place-items:center;border:1px solid var(--line);background:#1b2132}
.candle.lit{background:#2b3249;color:#ffd166;text-shadow:0 0 8px #ffd166}
.players{display:flex;flex-direction:column;gap:10px}
.player{border:1px dashed var(--line);border-radius:10px;padding:10px}
.hr{height:1px;background:var(--line);margin:8px 0}
.dice{font-family:ui-monospace,Menlo,Consolas,monospace;display:flex;gap:6px;flex-wrap:wrap}
.die{padding:3px 6px;border-radius:6px;border:1px solid var(--line);background:#0e1424;min-width:24px;text-align:center}
.die.six{background:#1a2a1e;color:var(--ok);border-color:#2a4a2f;font-weight:700}
.die.one{opacity:.7}
.success{color:var(--ok)} .fail{color:var(--bad)} .warn{color:var(--warn)}
input[type="text"]{width:100%;background:#0f1320;border:1px solid var(--line);color:#fff;border-radius:8px;padding:8px}
a{color:#8ee3f5}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>–î–µ—Å—è—Ç—å –°–≤–µ—á–µ–π</h1>
    <span class="pill" id="sceneP">–°—Ü–µ–Ω–∞ 1</span>
    <span class="pill" id="candlesP">–°–≤–µ—á–∏: 10</span>
    <span class="pill" id="poolP">–ü—É–ª –∏–≥—Ä–æ–∫–æ–≤: 10</span>
    <span class="pill" id="gmP">–ü—É–ª –ì–ú–∞: 0</span>
    <span class="pill" id="roomP">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span>
  </div>
</header>

<main>
  <section class="card">
    <div class="title">–°–≤–µ—á–∏ –∏ —Å—Ü–µ–Ω—ã</div>
    <div id="candles" class="candles"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn" id="extinguish">üïØ –ü–æ–≥–∞—Å–∏—Ç—å —Å–≤–µ—á—É</button>
      <button class="btn" id="newScene">üß≠ –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞</button>
      <span class="badge" id="finalB" style="display:none">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞: –ø—Ä–æ–≤–∞–ª = —Å–º–µ—Ä—Ç—å</span>
    </div>
    <div class="hr"></div>
    <div class="small">–†–∏—Ç—É–∞–ª –∏—Å—Ç–∏–Ω: ¬´<b>–í–æ—Ç –≤—Å—ë, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å. –ú–∏—Ä –ø–æ–≥—Ä—É–∂—ë–Ω –≤–æ —Ç—å–º—É.</b>¬ª ‚Üí –∏—Å—Ç–∏–Ω—ã = —á–∏—Å–ª—É —Å–≤–µ—á–µ–π ‚Üí –≤–º–µ—Å—Ç–µ: ¬´<b>–ò –º—ã –∂–∏–≤—ã</b>¬ª.</div>
  </section>

  <section class="card">
    <div class="title">–ò–≥—Ä–æ–∫–∏</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="name" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞" style="flex:1;min-width:140px">
      <button class="btn" id="add">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="players" class="players"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
    <div class="small">–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É –∂–µ —Å—Å—ã–ª–∫—É —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `?room=–Ω–∞–∑–≤–∞–Ω–∏–µ` –≤ –∫–æ–Ω—Ü–µ URL, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É (–ø—Ä–∏–º–µ—Ä: <code>?room=black-sargasso</code>).</div>
  </section>
</main>

<template id="pT">
  <div class="player">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="font-weight:700" class="nm"></div>
      <span class="badge">–ù–∞–¥–µ–∂–¥–∞: <b class="hope">–Ω–µ—Ç</b></span>
      <span class="badge">–ß–µ—Ä—Ç—ã: <span class="traits">2 –∞–∫—Ç–∏–≤–Ω—ã</span></span>
      <span class="badge">–ì—Ä–∞–Ω—å: <span class="brink">—Å–∫—Ä—ã—Ç–∞</span></span>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <label class="small"><input type="checkbox" class="danger"> –û–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç</label>
      <button class="btn roll">üé≤ –ë—Ä–æ—Å–æ–∫</button>
      <button class="btn rollH">üé≤+–ù–∞–¥–µ–∂–¥–∞</button>
      <button class="btn-ghost btn vBurn">üî• –î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª</button>
      <button class="btn-ghost btn cBurn">üî• –ü–æ—Ä–æ–∫ ‚Üí –ø–µ—Ä–µ–±—Ä–æ—Å ¬´1¬ª</button>
      <button class="btn-ghost btn brinkUse">‚ö° –ü—Ä–∏–Ω—è—Ç—å –ì—Ä–∞–Ω—å</button>
      <button class="btn-ghost btn intercept" style="display:none">üïØ –ü–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Ä–∞—Å—Å–∫–∞–∑</button>
      <button class="btn-ghost btn moment">‚ú® –ú–æ–º–µ–Ω—Ç</button>
    </div>
    <div class="hr"></div>
    <div class="small">–ü–æ—Å–ª–µ–¥–Ω–∏–π –±—Ä–æ—Å–æ–∫:</div>
    <div class="dice pDice"></div>
    <div class="small" style="margin-top:4px">–ö–æ—Å—Ç–∏ –ì–ú–∞:</div>
    <div class="dice gDice"></div>
    <div class="small res">‚Äî</div>
  </div>
</template>

<!-- Firebase SDK (–º–æ–¥—É–ª–∏) -->
<script type="module">
/* ====== Firebase init ====== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, onValue, update, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// >>> –í–°–¢–ê–í–¨ –°–í–û–ô firebaseConfig (–∏–∑ –∫–æ–Ω—Å–æ–ª–∏ Firebase)
const firebaseConfig = {
  apiKey: "PASTE_API_KEY",
  authDomain: "PASTE_AUTH_DOMAIN",
  databaseURL: "PASTE_DATABASE_URL",
  projectId: "PASTE_PROJECT_ID",
  storageBucket: "PASTE_BUCKET",
  messagingSenderId: "PASTE_SENDER",
  appId: "PASTE_APP_ID"
};
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ====== Helpers/State ====== */
const $=(s,r=document)=>r.querySelector(s);
const rng=n=>Array.from({length:Math.max(0,n)},()=>1+Math.floor(Math.random()*6));
const qs = new URLSearchParams(location.search);
const room = qs.get("room") || "default";
$('#roomP').textContent = "–ö–æ–º–Ω–∞—Ç–∞: " + room;

const roomRef = ref(db, `rooms/${room}`);

const blank = {
  scene:1, candles:10, shared:10, gmBonus:0,
  players:{}, // id: {name, hope, virtue, vice, brink:{known:false,available:false,burned:false}, last: {...}}
};

/* ====== Render ====== */
function pill(scene,candles,shared,gmBonus){
  $('#sceneP').textContent=`–°—Ü–µ–Ω–∞ ${scene}`;
  $('#candlesP').textContent=`–°–≤–µ—á–∏: ${candles}`;
  $('#poolP').textContent=`–ü—É–ª –∏–≥—Ä–æ–∫–æ–≤: ${shared}`;
  $('#gmP').textContent=`–ü—É–ª –ì–ú–∞: ${Math.max(0,scene-1)+gmBonus}`;
  $('#finalB').style.display = (candles===1)?'inline-block':'none';
}
function drawCandles(state){
  const box=$('#candles'); box.innerHTML='';
  for(let i=0;i<10;i++){
    const b=document.createElement('button');
    b.className='candle'+(i<state.candles?' lit':''); b.textContent=i<state.candles?'üïØ':'‚óº';
    b.onclick=async ()=>{
      const candles=i+1;
      const shared=candles; // –≤ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω—ã –æ–±—â–∏–π –ø—É–ª=—Å–≤–µ—á–∞–º
      await update(roomRef,{candles,shared});
    };
    box.appendChild(b);
  }
}
function fmtDice(a){ return a.map(v=>v===6?`[${v}]`:v).join(' '); }

function render(state){
  pill(state.scene,state.candles,state.shared,state.gmBonus);
  drawCandles(state);

  const wrap=$('#players'); wrap.innerHTML='';
  Object.entries(state.players).forEach(([id,p])=>{
    const t=$('#pT').content.cloneNode(true);
    $('.nm',t).textContent=p.name;
    $('.hope',t).textContent=p.hope?'–µ—Å—Ç—å':'–Ω–µ—Ç';
    $('.traits',t).textContent=(p.virtue?1:0)+(p.vice?1:0)+' –∞–∫—Ç–∏–≤–Ω—ã';
    $('.brink',t).textContent=p.brink?.burned?'—Å–æ–∂–∂–µ–Ω–∞':(p.brink?.available?'–∞–∫—Ç–∏–≤–Ω–∞':'—Å–∫—Ä—ã—Ç–∞');

    const res=$('.res',t), pD=$('.pDice',t), gD=$('.gDice',t);
    const danger=$('.danger',t);

    if(p.last){
      p.last.pDice.forEach(v=>{const s=document.createElement('span'); s.className='die'+(v===6?' six':(v===1?' one':'')); s.textContent=v; pD.appendChild(s);});
      p.last.gDice.forEach(v=>{const s=document.createElement('span'); s.className='die'+(v===6?' six':(v===1?' one':'')); s.textContent=v; gD.appendChild(s);});
      res.innerHTML=(p.last.success?'<span class="success">–£–°–ü–ï–•</span>':'<span class="fail">–ü–†–û–í–ê–õ</span>')+` ¬∑ —Ä–∞—Å—Å–∫–∞–∑: <b>${p.last.narrator}</b>`;
      if(p.last.canIntercept) $('.intercept',t).style.display='inline-block';
    }

    $('.roll',t).onclick=()=>roll(state,id,false,danger.checked);
    $('.rollH',t).onclick=()=>roll(state,id,true,danger.checked);
    $('.vBurn',t).onclick=()=>burnTrait(state,id,'virtue');
    $('.cBurn',t).onclick=()=>burnTrait(state,id,'vice');
    $('.brinkUse',t).onclick=()=>useBrink(state,id);
    $('.intercept',t).onclick=()=>intercept(state,id);
    $('.moment',t).onclick=()=>moment(state,id);

    wrap.appendChild(t);
  });
}

/* ====== Game Logic (with DB update) ====== */
async function ensureRoom(){
  const snap = await get(roomRef);
  if(!snap.exists()){
    await set(roomRef, {...blank});
  }
}

function gmPool(st){ return Math.max(0, st.scene-1)+ (st.gmBonus||0); }

async function extinguish(st, reason){
  if(st.candles<=0) return;
  const candles=st.candles-1, scene=st.scene+1;
  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –ø—É–ª–∞ –¥–æ —á–∏—Å–ª–∞ —Å–≤–µ—á–µ–π; –ª–∏—à–Ω–∏–µ –∫–æ—Å—Ç–∏ ‚Üí –≤ gmBonus
  let shared=candles, gmBonus=st.gmBonus||0;
  if(st.shared>candles){ gmBonus += (st.shared - candles); }
  await update(roomRef,{candles,scene,shared,gmBonus});
}

async function newScene(st){
  const scene=st.scene+1, candles=st.candles;
  let shared=candles, gmBonus=st.gmBonus||0;
  if(st.shared>candles){ gmBonus += (st.shared - candles); }
  await update(roomRef,{scene,shared,gmBonus});
}

async function addPlayerDB(name){
  const snap = await get(roomRef);
  const st = snap.val();
  const id = 'p'+Date.now();
  const player={
    name, hope:false, virtue:true, vice:true,
    brink:{known:false,available:false,burned:false}, last:null
  };
  await update(roomRef,{players:{...(st.players||{}), [id]:player}});
}

async function roll(st,id,withHope,isDanger){
  const p = st.players[id]; if(!p) return;
  const poolBefore = st.shared;
  if(poolBefore<=0) return alert('–û–±—â–∏–π –ø—É–ª –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É.');
  const pDice = rng(poolBefore);
  const gDice = rng(gmPool(st));
  let hopeVal=null; if(withHope && p.hope) hopeVal = 1+Math.floor(Math.random()*6);
  const success = pDice.includes(6) || (hopeVal!==null && hopeVal>=5);
  const pSix=pDice.filter(x=>x===6).length, gSix=gDice.filter(x=>x===6).length;
  const narrator = (success && pSix>gSix) ? '–∏–≥—Ä–æ–∫' : '–ì–ú';
  const ones = pDice.filter(x=>x===1).length;

  let updates = {};
  if(success){
    updates.shared = Math.max(0, poolBefore - ones);
  }else{
    await extinguish(st, isDanger? '–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ–≤–∞–ª':'–ø—Ä–æ–≤–∞–ª');
  }
  updates.players = {
    ...st.players,
    [id]:{...p, last:{pDice,gDice,hopeVal,success,narrator,ones,poolBefore,canIntercept:(success && narrator==='–ì–ú')}}
  };
  // –ì—Ä–∞–Ω—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ù–∞–¥–µ–∂–¥–∞ –∏ –æ–±–µ –ß–µ—Ä—Ç—ã —É–∂–µ —Å–æ–∂–∂–µ–Ω—ã
  const canBrink = (p.hope===true) && !p.virtue && !p.vice && !(p.brink?.burned);
  updates.players[id].brink = {...(p.brink||{}), available: canBrink};
  await update(roomRef, updates);
}

async function burnTrait(st,id,which){
  const p=st.players[id]; if(!p) return;
  if(which==='virtue' && !p.virtue) return alert('–î–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å —É–∂–µ —Å–æ–∂–∂–µ–Ω–∞.');
  if(which==='vice'   && !p.vice)   return alert('–ü–æ—Ä–æ–∫ —É–∂–µ —Å–æ–∂–∂—ë–Ω.');
  if(!p.last) return alert('–°–Ω–∞—á–∞–ª–∞ –±—Ä–æ—Å–æ–∫.');
  const idx=[]; p.last.pDice.forEach((v,i)=>{ if(v===1) idx.push(i); });
  if(!idx.length) return alert('–í –ø–æ—Å–ª–µ–¥–Ω–µ–º –±—Ä–æ—Å–∫–µ –Ω–µ—Ç ¬´1¬ª.');
  idx.forEach(i=> p.last.pDice[i]=1+Math.floor(Math.random()*6));
  const ones = p.last.pDice.filter(x=>x===1).length;
  const shared = Math.max(0, p.last.poolBefore - ones);
  const np = {...p, last:{...p.last, onesRemoved:ones}, [which]:false};
  const canBrink = (np.hope===true) && !np.virtue && !np.vice && !(np.brink?.burned);
  np.brink = {...(np.brink||{}), available: canBrink};
  await update(roomRef,{shared, players:{...st.players, [id]:np}});
}

async function useBrink(st,id){
  const p=st.players[id]; if(!p) return;
  if(!(p.brink&&p.brink.available)) return alert('–ì—Ä–∞–Ω—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.');
  if(!p.last) return alert('–°–Ω–∞—á–∞–ª–∞ –æ–±—ã—á–Ω—ã–π –±—Ä–æ—Å–æ–∫.');
  const pool=p.last.poolBefore;
  const pDice=rng(pool), gDice=rng(gmPool(st));
  const success = pDice.includes(6);
  const narrator = (success && pDice.filter(x=>x===6).length > gDice.filter(x=>x===6).length) ? '–∏–≥—Ä–æ–∫':'–ì–ú';
  const ones=pDice.filter(x=>x===1).length;

  if(success){
    const shared = Math.max(0, pool - ones);
    await update(roomRef,{shared, players:{...st.players, [id]:{...p, last:{pDice,gDice,hopeVal:null,success,narrator,ones,poolBefore:pool,canIntercept:(success && narrator==='–ì–ú')}}}});
  }else{
    // –ø—Ä–æ–≤–∞–ª –Ω–∞ –ì—Ä–∞–Ω–∏ ‚Äî –≥–∞—Å–Ω–µ—Ç —Å–≤–µ—á–∞, —Ç–µ—Ä—è–µ—Ç—Å—è –ù–∞–¥–µ–∂–¥–∞, –ì—Ä–∞–Ω—å —Å–≥–æ—Ä–∞–µ—Ç
    const np={...p, hope:false, brink:{...p.brink, burned:true, available:false}, last:{pDice,gDice,hopeVal:null,success,narrator,ones,poolBefore:pool,canIntercept:false}};
    await update(roomRef,{ players:{...st.players, [id]:np} });
    await extinguish(st,'–ø—Ä–æ–≤–∞–ª –ø–æ—Å–ª–µ –ì—Ä–∞–Ω–∏ (–ù–∞–¥–µ–∂–¥–∞ —É—Ç–µ—Ä—è–Ω–∞, –ì—Ä–∞–Ω—å —Å–æ–∂–∂–µ–Ω–∞)');
  }
}

async function intercept(st,id){
  const p=st.players[id]; if(!p || !p.last || !p.last.canIntercept) return;
  await extinguish(st,'–ø–µ—Ä–µ—Ö–≤–∞—Ç –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–≥—Ä–æ–∫–æ–º'); // —Ç—É—à–∏–º —Å–≤–µ—á—É —Ü–µ–Ω–æ–π –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
  const np={...p, last:{...p.last, canIntercept:false}};
  await update(roomRef,{ players:{...st.players, [id]:np} });
}

async function moment(st,id){
  const p=st.players[id]; if(!p) return;
  // –ë—Ä–æ—Å–æ–∫ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç
  const poolBefore=st.shared;
  const pDice=rng(poolBefore), gDice=rng(gmPool(st));
  const success = pDice.includes(6);
  const narrator = (success && pDice.filter(x=>x===6).length>gDice.filter(x=>x===6).length)?'–∏–≥—Ä–æ–∫':'–ì–ú';
  let updates={};
  if(success){
    const np={...p, hope:true, last:{pDice,gDice,hopeVal:null,success,narrator,ones:pDice.filter(x=>x===1).length,poolBefore,canIntercept:(success && narrator==='–ì–ú')}};
    np.brink = {...(p.brink||{}), available: (np.hope===true) && !np.virtue && !np.vice && !(np.brink?.burned)};
    updates.players={...st.players,[id]:np};
  }else{
    // –ú–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω ‚Äî —Ç—É—à–∏–º —Å–≤–µ—á—É
    await extinguish(st,'–ú–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–∞–ª—ë–Ω');
    const np={...p, last:{pDice,gDice,hopeVal:null,success,narrator,ones:pDice.filter(x=>x===1).length,poolBefore,canIntercept:false}};
    updates.players={...st.players,[id]:np};
  }
  await update(roomRef,updates);
}

/* ====== Wire UI ====== */
$('#add').onclick=async()=>{ const n=$('#name').value.trim() || `–ò–≥—Ä–æ–∫ ${Math.floor(Math.random()*90+10)}`; $('#name').value=''; await addPlayerDB(n); };
$('#extinguish').onclick=async()=>{ const snap=await get(roomRef); await extinguish(snap.val(),'—Ä–µ—à–µ–Ω–∏–µ –≤–µ–¥—É—â–µ–≥–æ/—Å–æ–±—ã—Ç–∏–µ'); };
$('#newScene').onclick=async()=>{ const snap=await get(roomRef); await newScene(snap.val()); };

/* ====== Live sync ====== */
await ensureRoom();
onValue(roomRef, (snap)=>{
  const st = snap.val();
  if(!st) return;
  render(st);
});
</script>
</body>
</html>
